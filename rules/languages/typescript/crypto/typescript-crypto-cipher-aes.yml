rules:
  - id: typescript-crypto-cipher-aes
    message: AES cipher usage detected
    severity: INFO
    languages:
      - typescript
    focus-metavariable: $KEY
    patterns:
      - pattern-either:
          - pattern: crypto.createCipher("aes-128-cbc", $KEY)
          - pattern: crypto.createCipher("aes-192-cbc", $KEY)
          - pattern: crypto.createCipher("aes-256-cbc", $KEY)
          - pattern: crypto.createCipheriv("aes-128-cbc", $KEY, $IV)
          - pattern: crypto.createCipheriv("aes-192-cbc", $KEY, $IV)
          - pattern: crypto.createCipheriv("aes-256-cbc", $KEY, $IV)
          - patterns:
              - pattern: crypto.createCipheriv($ALGORITHM, $KEY, $IV)
              - metavariable-regex:
                  metavariable: $ALGORITHM
                  regex: '"aes-[0-9]+-(cbc|gcm|ctr|cfb|ofb|ecb)"'
          - patterns:
              - pattern: crypto.createCipheriv($ALGORITHM, $KEY, $IV)
              - metavariable-regex:
                  metavariable: $ALGORITHM
                  regex: "'aes-[0-9]+-(cbc|gcm|ctr|cfb|ofb|ecb)'"
          - patterns:
              - pattern: |
                  const $ALGORITHM = "aes-256-cbc";
                  ...
                  crypto.createCipheriv($ALGORITHM, $KEY, $IV)
          - pattern: crypto.createDecipher("aes-128-cbc", $KEY)
          - pattern: crypto.createDecipher("aes-192-cbc", $KEY)
          - pattern: crypto.createDecipher("aes-256-cbc", $KEY)
          - pattern: crypto.createDecipheriv("aes-128-cbc", $KEY, $IV)
          - pattern: crypto.createDecipheriv("aes-192-cbc", $KEY, $IV)
          - pattern: crypto.createDecipheriv("aes-256-cbc", $KEY, $IV)
          - pattern: |
              $CIPHER: crypto.Cipher = crypto.createCipheriv("aes-256-gcm", $KEY, $IV);
              $CIPHERTEXT = $CIPHER.update($PLAINTEXT);
              $CIPHERTEXT += $CIPHER.final();
          - pattern: import * as CryptoJS from "crypto-js"; CryptoJS.AES.encrypt($DATA, $KEY)
          - pattern: CryptoJS.AES.encrypt($DATA, $KEY)
          - pattern: import * as CryptoJS from "crypto-js"; CryptoJS.AES.decrypt($DATA, $KEY)
          - pattern: CryptoJS.AES.decrypt($DATA, $KEY)
          - pattern: require("crypto-js").AES.encrypt($DATA, $KEY)
          - pattern: require("crypto-js").AES.decrypt($DATA, $KEY)
          - pattern: |
              $KEY = await crypto.subtle.generateKey(
                { name: "AES-GCM", length: 256 },
                true,
                ["encrypt", "decrypt"]
              );
          - pattern: |
              $KEY = await crypto.subtle.generateKey(
                { name: "AES-CBC", length: 256 },
                true,
                ["encrypt", "decrypt"]
              );
          - pattern: |
              $KEY = await crypto.subtle.generateKey(
                { name: "AES-CTR", length: 256 },
                true,
                ["encrypt", "decrypt"]
              );
          - pattern: |
              $KEY = await crypto.subtle.generateKey(
                { name: "AES-GCM", length: 128 },
                true,
                ["encrypt", "decrypt"]
              );
          - pattern: |
              $KEY = await crypto.subtle.generateKey(
                { name: "AES-GCM", length: 192 },
                true,
                ["encrypt", "decrypt"]
              );
          - pattern: |
              $KEY = await crypto.subtle.generateKey(
                { name: "AES-KW", length: 256 },
                true,
                ["wrapKey", "unwrapKey"]
              );
    pattern-not-inside:
      - pattern: |
          describe($NAME, () => {
            ...
          })
      - pattern: |
          it($NAME, () => {
            ...
          })
      - pattern: |
          test($NAME, () => {
            ...
          })
      - pattern: |
          // $COMMENT
      - pattern: |
          /* $COMMENT */

    metadata:
      category: crypto
      cwe: CWE-327
      impact: "Inventory: AES cipher usage detected in codebase"
