rules:
  - id: typescript-crypto-key-length
    message: Cryptographic key length usage detected
    severity: INFO
    languages:
      - typescript
    patterns:
      - pattern-either:
          - patterns:
              - pattern: |
                  crypto.subtle.generateKey({ name: "RSA-OAEP", modulusLength: $BITS, publicExponent: new Uint8Array([1, 0, 1]), hash: "SHA-256" }, $EXTRACTABLE, $USAGE)
              - metavariable-regex:
                  metavariable: $BITS
                  regex: '\d+'
              - focus-metavariable: $BITS
          - patterns:
              - pattern: |
                  crypto.subtle.generateKey({ name: "RSA-OAEP", modulusLength: $BITS, publicExponent: new Uint8Array([1, 0, 1]), hash: "SHA-256" }, $EXTRACTABLE, $USAGE)
              - metavariable-comparison:
                  metavariable: $BITS
                  comparison: $BITS < 2048
              - focus-metavariable: $BITS
          - patterns:
              - pattern: |
                  crypto.subtle.generateKey({ name: "RSA-PSS", modulusLength: $BITS, publicExponent: new Uint8Array([1, 0, 1]), hash: "SHA-256" }, $EXTRACTABLE, $USAGE)
              - metavariable-regex:
                  metavariable: $BITS
                  regex: '\d+'
              - focus-metavariable: $BITS
          - patterns:
              - pattern: |
                  crypto.subtle.generateKey({ name: "RSASSA-PKCS1-v1_5", modulusLength: $BITS, publicExponent: new Uint8Array([1, 0, 1]), hash: "SHA-256" }, $EXTRACTABLE, $USAGE)
              - metavariable-regex:
                  metavariable: $BITS
                  regex: '\d+'
              - focus-metavariable: $BITS
          - patterns:
              - pattern: |
                  crypto.subtle.generateKey({ name: "ECDSA", namedCurve: $CURVE }, $EXTRACTABLE, $USAGE)
              - metavariable-regex:
                  metavariable: $CURVE
                  regex: '"(P-224|P-256|P-384|P-521|secp160k1|secp256k1|prime256v1)"'
              - focus-metavariable: $CURVE
          - pattern: crypto.createECDH($CURVE)
          - patterns:
              - pattern: |
                  crypto.subtle.generateKey({ name: "AES-GCM", length: $LENGTH }, $EXTRACTABLE, $USAGE)
              - metavariable-regex:
                  metavariable: $LENGTH
                  regex: '\d+'
              - focus-metavariable: $LENGTH
          - patterns:
              - pattern: |
                  crypto.subtle.generateKey({ name: "AES-GCM", length: $LENGTH }, $EXTRACTABLE, $USAGE)
              - metavariable-comparison:
                  metavariable: $LENGTH
                  comparison: $LENGTH < 128
              - focus-metavariable: $LENGTH
          - patterns:
              - pattern: |
                  crypto.subtle.generateKey({ name: "AES-CBC", length: $LENGTH }, $EXTRACTABLE, $USAGE)
              - metavariable-regex:
                  metavariable: $LENGTH
                  regex: '\d+'
              - focus-metavariable: $LENGTH
          - patterns:
              - pattern: |
                  crypto.subtle.generateKey({ name: "AES-CTR", length: $LENGTH }, $EXTRACTABLE, $USAGE)
              - metavariable-regex:
                  metavariable: $LENGTH
                  regex: '\d+'
              - focus-metavariable: $LENGTH
          - patterns:
              - pattern: |
                  crypto.subtle.generateKey({ name: "AES-KW", length: $LENGTH }, $EXTRACTABLE, $USAGE)
              - metavariable-regex:
                  metavariable: $LENGTH
                  regex: '\d+'
              - focus-metavariable: $LENGTH
          - patterns:
              - pattern: |
                  $KEY = Buffer.alloc($SIZE);
                  ...
                  crypto.createCipheriv("aes-256-cbc", $KEY, $IV);
              - metavariable-regex:
                  metavariable: $SIZE
                  regex: '\d+'
              - focus-metavariable: $SIZE
          - patterns:
              - pattern: |
                  $KEY = new Uint8Array($SIZE);
                  ...
                  await crypto.subtle.importKey("raw", $KEY, { name: "AES-GCM" }, false, ["encrypt", "decrypt"]);
              - metavariable-regex:
                  metavariable: $SIZE
                  regex: '\d+'
              - focus-metavariable: $SIZE
          - patterns:
              - pattern: crypto.pbkdf2Sync($PASSWORD, $SALT, $ITER, $KEYLEN, $DIGEST)
              - metavariable-regex:
                  metavariable: $KEYLEN
                  regex: '\d+'
              - focus-metavariable: $KEYLEN
          - patterns:
              - pattern: crypto.scryptSync($PASSWORD, $SALT, $KEYLEN, $OPTIONS)
              - metavariable-regex:
                  metavariable: $KEYLEN
                  regex: '\d+'
              - focus-metavariable: $KEYLEN
          - patterns:
              - pattern: |
                  await crypto.subtle.deriveKey(
                    { name: "PBKDF2", salt: $SALT, iterations: $ITER, hash: "SHA-256" },
                    $BASE_KEY,
                    { name: "AES-GCM", length: $LENGTH },
                    false,
                    ["encrypt", "decrypt"]
                  );
              - metavariable-regex:
                  metavariable: $LENGTH
                  regex: '\d+'
              - focus-metavariable: $LENGTH
    pattern-not-inside:
      - pattern: |
          describe($NAME, () => {
            ...
          })
      - pattern: |
          it($NAME, () => {
            ...
          })
      - pattern: |
          test($NAME, () => {
            ...
          })
      - pattern: |
          // $COMMENT
      - pattern: |
          /* $COMMENT */
    metadata:
      category: crypto
      cwe: CWE-326
      impact: "Inventory: Cryptographic key length usage detected in codebase"
