rules:
  - id: typescript-crypto-pbkdf2
    message: PBKDF2 key derivation function usage detected
    severity: INFO
    languages:
      - typescript
    focus-metavariable: $PASSWORD
    patterns:
      - pattern-either:
          - pattern: crypto.pbkdf2($PASSWORD, $SALT, $ITER, $KEYLEN, $DIGEST, $CALLBACK)
          - pattern: crypto.pbkdf2Sync($PASSWORD, $SALT, $ITER, $KEYLEN, $DIGEST)
          - pattern: |
              crypto.pbkdf2($PASSWORD, $SALT, $ITER, $KEYLEN, "sha256", function($ERR, $KEY) {
                ...
              });
          - pattern: |
              $KEY = crypto.pbkdf2Sync($PASSWORD, $SALT, $ITER, $KEYLEN, "sha256");
          - patterns:
              - pattern: crypto.pbkdf2Sync($PASSWORD, $SALT, $ITER, $KEYLEN, $DIGEST)
              - metavariable-regex:
                  metavariable: $ITER
                  regex: '\d+'
              - metavariable-regex:
                  metavariable: $KEYLEN
                  regex: '\d+'
          - patterns:
              - pattern: crypto.pbkdf2Sync($PASSWORD, $SALT, $ITER, $KEYLEN, $DIGEST)
              - metavariable-comparison:
                  metavariable: $ITER
                  comparison: $ITER < 100000
          - patterns:
              - pattern: |
                  await crypto.subtle.deriveKey(
                    { name: "PBKDF2", salt: $SALT, iterations: $ITER, hash: "SHA-256" },
                    $BASE_KEY,
                    { name: "AES-GCM", length: 256 },
                    false,
                    ["encrypt", "decrypt"]
                  );
              - metavariable-comparison:
                  metavariable: $ITER
                  comparison: $ITER < 100000
          - pattern: |
              $KEY = await crypto.subtle.deriveKey(
                { name: "PBKDF2", salt: $SALT, iterations: $ITER, hash: "SHA-256" },
                $BASE_KEY,
                { name: "AES-GCM", length: 256 },
                false,
                ["encrypt", "decrypt"]
              );
          - patterns:
              - pattern: crypto.pbkdf2Sync($PASSWORD, $SALT, $ITER, $KEYLEN, $DIGEST)
              - metavariable-regex:
                  metavariable: $DIGEST
                  regex: '"(sha256|sha512|sha1|sha384|sha224)"'
          - patterns:
              - pattern: crypto.pbkdf2Sync($PASSWORD, $SALT, $ITER, $KEYLEN, $DIGEST)
              - metavariable-regex:
                  metavariable: $DIGEST
                  regex: "'(sha256|sha512|sha1|sha384|sha224)'"
          - pattern: |
              const $LIBRARY = await import("crypto");
              await $LIBRARY.pbkdf2($PASSWORD, $SALT, $ITER, $KEYLEN, $DIGEST, $CALLBACK);
    pattern-not-inside:
      - pattern: |
          describe($NAME, () => {
            ...
          })
      - pattern: |
          it($NAME, () => {
            ...
          })
      - pattern: |
          test($NAME, () => {
            ...
          })
      - pattern: |
          // $COMMENT
      - pattern: |
          /* $COMMENT */
    metadata:
      category: crypto
      cwe: CWE-326
      impact: "Inventory: PBKDF2 key derivation function usage detected in codebase"
