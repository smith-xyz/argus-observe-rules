rules:
  - id: c-crypto-tls-version
    message: TLS/SSL version configuration detected
    severity: INFO
    languages:
      - c
    patterns:
      - pattern-either:
          # Patterns with $VERSION - extract version
          - patterns:
              - pattern: SSL_CTX_set_min_proto_version($CTX, $VERSION)
              - metavariable-regex:
                  metavariable: $VERSION
                  regex: "(TLS1_[0-3]_VERSION|SSL3_VERSION|SSL2_VERSION|DTLS1_VERSION|DTLS1_2_VERSION)"
              - focus-metavariable: $VERSION
          - patterns:
              - pattern: SSL_CTX_set_max_proto_version($CTX, $VERSION)
              - metavariable-regex:
                  metavariable: $VERSION
                  regex: "(TLS1_[0-3]_VERSION|SSL3_VERSION|SSL2_VERSION|DTLS1_VERSION|DTLS1_2_VERSION)"
              - focus-metavariable: $VERSION
          - patterns:
              - pattern: SSL_set_min_proto_version($SSL, $VERSION)
              - metavariable-regex:
                  metavariable: $VERSION
                  regex: "(TLS1_[0-3]_VERSION|SSL3_VERSION|SSL2_VERSION|DTLS1_VERSION|DTLS1_2_VERSION)"
              - focus-metavariable: $VERSION
          - patterns:
              - pattern: SSL_set_max_proto_version($SSL, $VERSION)
              - metavariable-regex:
                  metavariable: $VERSION
                  regex: "(TLS1_[0-3]_VERSION|SSL3_VERSION|SSL2_VERSION|DTLS1_VERSION|DTLS1_2_VERSION)"
              - focus-metavariable: $VERSION
          # Fallback patterns without $VERSION - still match
          - pattern: SSL_CTX_new(SSLv2_method())
          - pattern: SSL_CTX_new(SSLv3_method())
          - pattern: SSL_CTX_new(TLSv1_method())
          - pattern: SSL_CTX_new(TLSv1_1_method())
          - pattern: SSL_CTX_new(TLSv1_2_method())
          - pattern: SSL_CTX_new(TLSv1_3_method())
          - pattern: SSL_CTX_new(SSLv23_method())
          - pattern: SSL_CTX_new(DTLSv1_method())
          - pattern: SSL_CTX_new(DTLSv1_2_method())
          - pattern: SSL_CTX_set_options($CTX, SSL_OP_NO_SSLv2)
          - pattern: SSL_CTX_set_options($CTX, SSL_OP_NO_SSLv3)
          - pattern: SSL_CTX_set_options($CTX, SSL_OP_NO_TLSv1)
          - pattern: SSL_CTX_set_options($CTX, SSL_OP_NO_TLSv1_1)
          - pattern: SSL_CTX_set_options($CTX, SSL_OP_NO_TLSv1_2)
          - pattern: SSL_CTX_set_options($CTX, SSL_OP_NO_TLSv1_3)
    metadata:
      category: crypto
      cwe: CWE-327
      impact: "Inventory: TLS/SSL version configuration detected in codebase"
