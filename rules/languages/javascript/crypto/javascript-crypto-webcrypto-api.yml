rules:
  - id: javascript-crypto-webcrypto-api
    message: Web Crypto API usage detected
    severity: INFO
    languages:
      - javascript
    patterns:
      - pattern-either:
          - pattern: crypto.subtle.encrypt($ALGO, $KEY, $DATA)
          - pattern: crypto.subtle.decrypt($ALGO, $KEY, $DATA)
          - pattern: crypto.subtle.sign($ALGO, $KEY, $DATA)
          - pattern: crypto.subtle.verify($ALGO, $KEY, $SIG, $DATA)
          - pattern: crypto.subtle.generateKey($ALGO, $EXTRACTABLE, $USAGE)
          - pattern: crypto.subtle.deriveKey($ALGO, $BASE_KEY, $DERIVED_ALGO, $EXTRACTABLE, $USAGE)
          - pattern: crypto.subtle.deriveBits($ALGO, $BASE_KEY, $LENGTH)
          - pattern: crypto.subtle.digest($ALGO, $DATA)
          - pattern: crypto.subtle.importKey($FORMAT, $KEY_DATA, $ALGO, $EXTRACTABLE, $USAGE)
          - pattern: crypto.subtle.exportKey($FORMAT, $KEY)
          - pattern: crypto.subtle.wrapKey($FORMAT, $KEY, $WRAPPING_KEY, $WRAP_ALGO)
          - pattern: crypto.subtle.unwrapKey($FORMAT, $WRAPPED_KEY, $UNWRAPPING_KEY, $UNWRAP_ALGO, $UNWRAPPED_ALGO, $EXTRACTABLE, $USAGE)
          - pattern: |
              $KEY = await crypto.subtle.generateKey(
                { name: "AES-GCM", length: 256 },
                true,
                ["encrypt", "decrypt"]
              );
          - pattern: |
              $HASH = await crypto.subtle.digest("SHA-256", $DATA);
          - pattern: |
              $KEY = await crypto.subtle.importKey("raw", $KEY_DATA, "AES-GCM", false, ["encrypt"]);
          - pattern: |
              $KEY_DATA = await crypto.subtle.exportKey("raw", $KEY);
          - pattern: |
              $WRAPPED = await crypto.subtle.wrapKey("raw", $KEY, $WRAPPING_KEY, { name: "AES-KW" });
          - pattern: |
              $UNWRAPPED = await crypto.subtle.unwrapKey("raw", $WRAPPED_KEY, $UNWRAPPING_KEY, { name: "AES-KW" }, "AES-GCM", false, ["encrypt"]);
          - pattern: |
              crypto.subtle.encrypt({ name: "ChaCha20-Poly1305", iv: $IV }, $KEY, $DATA)
          - pattern: |
              crypto.subtle.decrypt({ name: "ChaCha20-Poly1305", iv: $IV }, $KEY, $DATA)
          - pattern: |
              crypto.subtle.generateKey({ name: "X25519" }, $EXTRACTABLE, $USAGE)
          - pattern: |
              crypto.subtle.generateKey({ name: "X448" }, $EXTRACTABLE, $USAGE)
          - pattern: |
              crypto.subtle.generateKey({ name: "Ed25519" }, $EXTRACTABLE, $USAGE)
          - pattern: |
              crypto.subtle.generateKey({ name: "Ed448" }, $EXTRACTABLE, $USAGE)
          - pattern: |
              crypto.subtle.sign({ name: "Ed25519" }, $PRIVATE_KEY, $DATA)
          - pattern: |
              crypto.subtle.verify({ name: "Ed25519" }, $PUBLIC_KEY, $SIG, $DATA)
          - pattern: |
              crypto.subtle.sign({ name: "Ed448" }, $PRIVATE_KEY, $DATA)
          - pattern: |
              crypto.subtle.verify({ name: "Ed448" }, $PUBLIC_KEY, $SIG, $DATA)
          - pattern: |
              crypto.subtle.deriveKey({ name: "X25519" }, $PRIVATE_KEY, $PUBLIC_KEY, $DERIVED_ALGO, $EXTRACTABLE, $USAGE)
          - pattern: |
              crypto.subtle.deriveKey({ name: "X448" }, $PRIVATE_KEY, $PUBLIC_KEY, $DERIVED_ALGO, $EXTRACTABLE, $USAGE)
          - pattern: |
              crypto.subtle.deriveBits({ name: "X25519" }, $PRIVATE_KEY, $PUBLIC_KEY, $LENGTH)
          - pattern: |
              crypto.subtle.deriveBits({ name: "X448" }, $PRIVATE_KEY, $PUBLIC_KEY, $LENGTH)
      - pattern-not-inside: |
          describe($NAME, function() {
            ...
          })
      - pattern-not-inside: |
          describe($NAME, () => {
            ...
          })
      - pattern-not-inside: |
          it($NAME, function() {
            ...
          })
      - pattern-not-inside: |
          it($NAME, () => {
            ...
          })
      - pattern-not-inside: |
          test($NAME, function() {
            ...
          })
      - pattern-not-inside: |
          test($NAME, () => {
            ...
          })
    metadata:
      category: crypto
      cwe: CWE-327
      impact: "Inventory: Web Crypto API usage detected in codebase"
