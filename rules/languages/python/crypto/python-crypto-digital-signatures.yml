rules:
  - id: python-crypto-digital-signatures
    message: Digital signature operations detected
    severity: INFO
    languages:
      - python
    focus-metavariable: $PRIVATE_KEY
    paths:
      include:
        - "**/*.py"
        - "**/*.pyi"
      exclude:
        - "**/__pycache__/**"
        - "**/*.pyc"
    patterns:
      - pattern-either:
          - pattern: |
              $PRIVATE_KEY = rsa.generate_private_key($PUBLIC_EXPONENT, $KEY_SIZE, $BACKEND)
              ...
              $PRIVATE_KEY.sign($DATA, $PADDING, $ALGORITHM)
          - pattern: |
              $PUBLIC_KEY = $PRIVATE_KEY.public_key()
              ...
              $PUBLIC_KEY.verify($SIGNATURE, $DATA, $PADDING, $ALGORITHM)
          - pattern: |
              $PRIVATE_KEY = ec.generate_private_key($CURVE, $BACKEND)
              ...
              $PRIVATE_KEY.sign($DATA, $ALGORITHM)
          - pattern: |
              $PUBLIC_KEY = $PRIVATE_KEY.public_key()
              ...
              $PUBLIC_KEY.verify($SIGNATURE, $DATA, $ALGORITHM)
          - pattern: |
              from Crypto.Signature import pkcs1_15
              $SIGNER = pkcs1_15.new($PRIVATE_KEY)
              $SIGNATURE = $SIGNER.sign($HASH)
          - pattern: |
              from Crypto.Signature import pkcs1_15
              $VERIFIER = pkcs1_15.new($PUBLIC_KEY)
              $VERIFIER.verify($HASH, $SIGNATURE)
          - pattern: |
              from Crypto.Signature import DSS
              $SIGNER = DSS.new($PRIVATE_KEY, $MODE)
              $SIGNATURE = $SIGNER.sign($HASH)
          - pattern: |
              from Crypto.Signature import DSS
              $VERIFIER = DSS.new($PUBLIC_KEY, $MODE)
              $VERIFIER.verify($HASH, $SIGNATURE)
          - pattern: |
              from ecdsa import SigningKey
              $KEY = SigningKey.generate(curve=$CURVE)
              $SIGNATURE = $KEY.sign($DATA)
          - pattern: |
              from ecdsa import VerifyingKey
              $KEY = VerifyingKey.from_string($KEY_DATA, curve=$CURVE)
              $KEY.verify($SIGNATURE, $DATA)
          - pattern: |
              from cryptography.hazmat.primitives.asymmetric import padding
              $SIGNATURE = $PRIVATE_KEY.sign($DATA, padding.PKCS1v15(), $ALGORITHM)
          - pattern: |
              from cryptography.hazmat.primitives.asymmetric import padding
              $PUBLIC_KEY.verify($SIGNATURE, $DATA, padding.PKCS1v15(), $ALGORITHM)
          - pattern: |
              from cryptography.hazmat.primitives.asymmetric import padding
              $SIGNATURE = $PRIVATE_KEY.sign($DATA, padding.PSS($MGF, $SALT_LENGTH), $ALGORITHM)
          - pattern: |
              from cryptography.hazmat.primitives.asymmetric import padding
              $PUBLIC_KEY.verify($SIGNATURE, $DATA, padding.PSS($MGF, $SALT_LENGTH), $ALGORITHM)
          - pattern: |
              from cryptography.hazmat.primitives.asymmetric import ed25519
              $PRIVATE_KEY = ed25519.Ed25519PrivateKey.generate()
              $SIGNATURE = $PRIVATE_KEY.sign($DATA)
          - pattern: |
              from cryptography.hazmat.primitives.asymmetric import ed25519
              $PUBLIC_KEY = $PRIVATE_KEY.public_key()
              $PUBLIC_KEY.verify($SIGNATURE, $DATA)
          - pattern: |
              from cryptography.hazmat.primitives.asymmetric import ed448
              $PRIVATE_KEY = ed448.Ed448PrivateKey.generate()
              $SIGNATURE = $PRIVATE_KEY.sign($DATA)
          - pattern: |
              from cryptography.hazmat.primitives.asymmetric import ed448
              $PUBLIC_KEY = $PRIVATE_KEY.public_key()
              $PUBLIC_KEY.verify($SIGNATURE, $DATA)

    pattern-not-inside:
      - pattern: |
          """
          $DOCSTRING
          """
    metadata:
      category: crypto
      cwe: CWE-327
      impact: "Inventory: Digital signature operations detected in codebase"
