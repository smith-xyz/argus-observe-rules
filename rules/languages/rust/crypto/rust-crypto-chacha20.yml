rules:
  - id: rust-crypto-chacha20
    message: ChaCha20 cipher usage detected
    severity: INFO
    languages:
      - rust
    patterns:
      - pattern-either:
          - pattern: ring::aead::CHACHA20_POLY1305
          - pattern: ring::aead::SealingKey::new(&ring::aead::CHACHA20_POLY1305, $KEY)
          - pattern: ring::aead::OpeningKey::new(&ring::aead::CHACHA20_POLY1305, $KEY)
          - pattern: ring::aead::LessSafeKey::new(ring::aead::UnboundKey::new(&ring::aead::CHACHA20_POLY1305, $KEY))
          - pattern: ring::aead::LessSafeKey::seal_in_place($KEY, $NONCE, $AAD, $PLAINTEXT, $OUT)
          - pattern: ring::aead::LessSafeKey::open_in_place($KEY, $NONCE, $AAD, $CIPHERTEXT, $OUT)
          - pattern: ring::aead::UnboundKey::new(&ring::aead::CHACHA20_POLY1305, $KEY)
          - pattern: ring::aead::UnboundKey::new_less_safe_key(&ring::aead::CHACHA20_POLY1305, $KEY)
          - pattern: ring::aead::SealingKey::new_from_unbound_key($UNBOUND_KEY)
          - pattern: ring::aead::OpeningKey::new_from_unbound_key($UNBOUND_KEY)
          - pattern: |
              let $SEALING_KEY = ring::aead::SealingKey::new(&ring::aead::CHACHA20_POLY1305, $KEY);
              let $CIPHERTEXT = ring::aead::seal_in_place($SEALING_KEY, $NONCE, $AAD, $PLAINTEXT, $OUT);
          - pattern: |
              let $OPENING_KEY = ring::aead::OpeningKey::new(&ring::aead::CHACHA20_POLY1305, $KEY);
              let $PLAINTEXT = ring::aead::open_in_place($OPENING_KEY, $NONCE, $AAD, $CIPHERTEXT, $OUT);
          - pattern: chacha20::ChaCha20::new($KEY, $NONCE)
          - pattern: chacha20::ChaCha20Rng::from_seed($SEED)
          - pattern: chacha20poly1305::ChaCha20Poly1305::new_from_slice($KEY)
          - pattern: |
              use chacha20poly1305::{ChaCha20Poly1305, KeyInit, Aead};
              let $CIPHER = ChaCha20Poly1305::new_from_slice($KEY);
              $CIPHER.encrypt($NONCE, $PLAINTEXT)
          - pattern: |
              use chacha20poly1305::{ChaCha20Poly1305, KeyInit, Aead};
              let $CIPHER = ChaCha20Poly1305::new_from_slice($KEY);
              $CIPHER.decrypt($NONCE, $CIPHERTEXT)
          - pattern: |
              use chacha20poly1305::{ChaCha20Poly1305, KeyInit, Aead};
              let $CIPHER = ChaCha20Poly1305::new(KeyInit::init($KEY));
              $CIPHER.encrypt($NONCE, $PLAINTEXT)
          - pattern: |
              async fn $FUNC() {
                  let $CIPHER = chacha20poly1305::ChaCha20Poly1305::new_from_slice($KEY);
                  $CIPHER.encrypt($NONCE, $PLAINTEXT)
              }
      - pattern-not-inside: |
          #[test]
          fn $TEST() {
              ...
          }
      - pattern-not-inside: |
          #[cfg(test)]
          mod $MODULE {
              ...
          }
      - pattern-not-inside: |
          mod tests {
              ...
          }
    metadata:
      category: crypto
      cwe: CWE-327
      impact: "Inventory: ChaCha20 cipher usage detected in codebase"
