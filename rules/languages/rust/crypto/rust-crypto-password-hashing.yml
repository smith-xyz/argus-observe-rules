rules:
  - id: rust-crypto-password-hashing
    message: Password hashing operations detected
    severity: INFO
    languages:
      - rust
    patterns:
      - pattern-either:
          - pattern: bcrypt::hash($PASSWORD, $COST)
          - pattern: bcrypt::verify($PASSWORD, $HASH)
          - pattern: bcrypt::DEFAULT_COST
          - patterns:
              - pattern: bcrypt::hash($PASSWORD, $COST)
              - metavariable-regex:
                  metavariable: $COST
                  regex: \d+
          - pattern: |
              let $HASH = bcrypt::hash($PASSWORD, bcrypt::DEFAULT_COST);
              bcrypt::verify($INPUT, &$HASH)
          - pattern: |
              use bcrypt::{hash, verify, DEFAULT_COST};
              hash($PASSWORD, DEFAULT_COST)
          - pattern: argon2::hash_encoded($PASSWORD, $SALT, &$CONFIG, $ALGO)
          - pattern: argon2::verify_encoded($HASH, $PASSWORD)
          - pattern: scrypt::scrypt($PASSWORD, $SALT, &$PARAMS, $OUTPUT)
          - pattern: scrypt::verify($HASH, $PASSWORD)
          - pattern: |
              use scrypt::{scrypt, ScryptParams};
              let $PARAMS = ScryptParams::recommended();
              scrypt($PASSWORD, $SALT, &$PARAMS, $OUTPUT)
          - pattern: pbkdf2::pbkdf2($PASSWORD, $SALT, $ITER, $OUTPUT)
          - patterns:
              - pattern: pbkdf2::pbkdf2_hmac::<sha2::Sha256>($PASSWORD, $SALT, $ITER, $OUTPUT)
              - metavariable-regex:
                  metavariable: $ITER
                  regex: \d+
          - patterns:
              - pattern: pbkdf2::pbkdf2_hmac::<sha2::Sha512>($PASSWORD, $SALT, $ITER, $OUTPUT)
              - metavariable-regex:
                  metavariable: $ITER
                  regex: \d+
          - patterns:
              - pattern: |
                  use pbkdf2::{pbkdf2_hmac, pbkdf2};
                  use sha2::Sha256;
                  pbkdf2_hmac::<Sha256>($PASSWORD, $SALT, $ITER, $OUTPUT)
              - metavariable-regex:
                  metavariable: $ITER
                  regex: \d+
          - pattern: |
              async fn $FUNC() {
                  bcrypt::hash($PASSWORD, bcrypt::DEFAULT_COST)
              }
      - pattern-not-inside: |
          #[test]
          fn $TEST() {
              ...
          }
      - pattern-not-inside: |
          #[cfg(test)]
          mod $MODULE {
              ...
          }
      - pattern-not-inside: |
          mod tests {
              ...
          }
    metadata:
      category: crypto
      cwe: CWE-916
      impact: "Inventory: Password hashing operations detected in codebase"
