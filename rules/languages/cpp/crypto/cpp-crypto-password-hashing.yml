rules:
  - id: cpp-crypto-password-hashing
    message: Password hashing operations detected
    severity: INFO
    languages:
      - cpp
    patterns:
      - pattern-either:
          - patterns:
              - pattern: PKCS5_PBKDF2_HMAC($PASS, $PASSLEN, $SALT, $SALTLEN, $ITER, $DIGEST, $KEYLEN, $OUT)
              - metavariable-regex:
                  metavariable: $ITER
                  regex: '\d+'
              - focus-metavariable: $ITER
          - patterns:
              - pattern: PKCS5_PBKDF2_HMAC_SHA1($PASS, $PASSLEN, $SALT, $SALTLEN, $ITER, $KEYLEN, $OUT)
              - metavariable-regex:
                  metavariable: $ITER
                  regex: '\d+'
              - focus-metavariable: $ITER
          - pattern: EVP_PBE_scrypt($PASS, $PASSLEN, $SALT, $SALTLEN, $N, $R, $P, $MAXMEM, $KEY, $KEYLEN)
          - pattern: EVP_KDF_fetch($ENGINE, "PBKDF2", $PROPS)
          - pattern: EVP_KDF_fetch($ENGINE, "scrypt", $PROPS)
          - pattern: EVP_KDF_fetch($ENGINE, "Argon2", $PROPS)
          - pattern: CryptoPP::PKCS5_PBKDF2_HMAC<$HASH>()
          - pattern: CryptoPP::Scrypt().DeriveKey($KEY, $KEYLEN, $PASS, $PASSLEN, $SALT, $SALTLEN, $N, $R, $P)
          - pattern: Botan::PBKDF2($PBKDF)
          - pattern: Botan::Scrypt().derive_key($KEYLEN, $PASS, $SALT, $N, $R, $P)
          - pattern: Botan::Argon2($MEMORY, $PARALLELISM, $ITERATIONS)
          - pattern: |
              CryptoPP::PKCS5_PBKDF2_HMAC<$HASH> $PBKDF;
              $PBKDF.DeriveKey($KEY, $KEYLEN, $PASS, $PASSLEN, $SALT, $SALTLEN, $ITER);
          - pattern: argon2_hash($TIME_COST, $MEMORY_COST, $PARALLELISM, $PWD, $PWD_LEN, $SALT, $SALTLEN, $HASH, $HASH_LEN, $ENCODED, $ENCODED_LEN, $TYPE, $VERSION)
          - pattern: argon2i_hash($TIME_COST, $MEMORY_COST, $PARALLELISM, $PWD, $PWD_LEN, $SALT, $SALTLEN, $HASH, $HASH_LEN, $ENCODED, $ENCODED_LEN, $VERSION)
          - pattern: argon2id_hash($TIME_COST, $MEMORY_COST, $PARALLELISM, $PWD, $PWD_LEN, $SALT, $SALTLEN, $HASH, $HASH_LEN, $ENCODED, $ENCODED_LEN, $VERSION)
          - pattern: argon2d_hash($TIME_COST, $MEMORY_COST, $PARALLELISM, $PWD, $PWD_LEN, $SALT, $SALTLEN, $HASH, $HASH_LEN, $ENCODED, $ENCODED_LEN, $VERSION)
          - patterns:
              - pattern: argon2id_hash($TIME_COST, $MEMORY_COST, $PARALLELISM, $PWD, $PWD_LEN, $SALT, $SALTLEN, $HASH, $HASH_LEN, $ENCODED, $ENCODED_LEN, $VERSION)
              - metavariable-regex:
                  metavariable: $TIME_COST
                  regex: '\d+'
              - metavariable-regex:
                  metavariable: $MEMORY_COST
                  regex: '\d+'
          - patterns:
              - pattern: argon2i_hash($TIME_COST, $MEMORY_COST, $PARALLELISM, $PWD, $PWD_LEN, $SALT, $SALTLEN, $HASH, $HASH_LEN, $ENCODED, $ENCODED_LEN, $VERSION)
              - metavariable-regex:
                  metavariable: $TIME_COST
                  regex: '\d+'
              - metavariable-regex:
                  metavariable: $MEMORY_COST
                  regex: '\d+'
          - patterns:
              - pattern: CryptoPP::Scrypt().DeriveKey($KEY, $KEYLEN, $PASS, $PASSLEN, $SALT, $SALTLEN, $N, $R, $P)
              - metavariable-regex:
                  metavariable: $N
                  regex: '\d+'
              - metavariable-regex:
                  metavariable: $R
                  regex: '\d+'
              - metavariable-regex:
                  metavariable: $P
                  regex: '\d+'
          - patterns:
              - pattern: Botan::Scrypt().derive_key($KEYLEN, $PASS, $SALT, $N, $R, $P)
              - metavariable-regex:
                  metavariable: $N
                  regex: '\d+'
              - metavariable-regex:
                  metavariable: $R
                  regex: '\d+'
              - metavariable-regex:
                  metavariable: $P
                  regex: '\d+'
          - patterns:
              - pattern: Botan::Argon2($MEMORY, $PARALLELISM, $ITERATIONS)
              - metavariable-regex:
                  metavariable: $MEMORY
                  regex: '\d+'
              - metavariable-regex:
                  metavariable: $ITERATIONS
                  regex: '\d+'
          - patterns:
              - pattern: |
                  CryptoPP::PKCS5_PBKDF2_HMAC<$HASH> $PBKDF;
                  $PBKDF.DeriveKey($KEY, $KEYLEN, $PASS, $PASSLEN, $SALT, $SALTLEN, $ITER);
              - metavariable-regex:
                  metavariable: $ITER
                  regex: '\d+'
              - focus-metavariable: $ITER
    metadata:
      category: crypto
      cwe: CWE-326
      impact: "Inventory: Password hashing operations detected in codebase"
