rules:
  - id: go-dynamic-weak-cipher
    message: Dynamic cipher selection may use weak algorithms
    severity: WARNING
    languages:
      - go
    patterns:
      - pattern-either:
          - pattern: |
              switch $ALGO {
              case "des":
                $CIPHER = des.NewCipher($KEY)
              ...
              }
          - pattern: |
              if $ALGO == "rc4" {
                $CIPHER = rc4.NewCipher($KEY)
              }
          - pattern: |
              if $ALGO == "des" {
                $CIPHER = des.NewCipher($KEY)
              }
          - pattern: |
              $CIPHERS := map[string]func([]byte) (cipher.Block, error){
                ...,
                "des": des.NewCipher,
                ...
              }
          - pattern: |
              $CIPHERS := map[string]func([]byte) (cipher.Stream, error){
                ...,
                "rc4": rc4.NewCipher,
                ...
              }
          - pattern: |
              func getCipher($TYPE string, $KEY []byte) cipher.Block {
                ...
                return des.NewCipher($KEY)
                ...
              }
          - pattern: |
              $CIPHER := getCipherByName($CONFIG.Algorithm, $KEY)
    fix: Avoid dynamic cipher selection or whitelist only strong algorithms like AES
    metadata:
      category: crypto
      cwe: CWE-327
      impact: Dynamic cipher selection can allow weak algorithms through configuration
