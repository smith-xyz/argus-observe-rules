rules:
  - id: go-service-mesh-bypass
    message: Service mesh TLS bypass detected - communication outside mesh security
    severity: ERROR
    languages:
      - go
    patterns:
      - pattern-either:
          - pattern: |
              $URL := "http://" + $SERVICE_IP + ":" + $PORT
              http.Get($URL)
          - pattern: |
              $CLIENT := &http.Client{
                Transport: &http.Transport{
                  Proxy: http.ProxyFromEnvironment,
                },
              }
          - pattern: |
              $ENDPOINTS := $FUNC($SERVICE_NAME)
              for _, $ENDPOINT := range $ENDPOINTS {
                $URL := "http://" + $ENDPOINT
                http.Get($URL)
              }
          - pattern: |
              if os.Getenv("BYPASS_SIDECAR") == "true" {
                return &http.Client{
                  Transport: &http.Transport{
                    TLSClientConfig: &tls.Config{
                      InsecureSkipVerify: true,
                    },
                  },
                }
              }
          - pattern: $CONFIG.ServerName = ""
          - pattern: $CONFIG.ServerName = $CUSTOM_SNI
          - pattern: |
              if $FUNC(...) {
                $URL := $FUNC2(...)
                http.Get($URL)
              }
          - pattern: |
              $BYPASS := $OBJ.$FIELD
              if $BYPASS {
                return $FUNC(...)
              }
          - pattern: |
              $CLIENT := $FUNC(...)
              if $CLIENT.$METHOD(...) {
                $CLIENT.$METHOD2(...)
              }
          - pattern: |
              $CLIENT := func() $TYPE {
                if $FUNC(...) {
                  return &http.Client{Transport: $FUNC2(...)}
                }
                return $FUNC3(...)
              }()
          - pattern: |
              if $OBJ.$METHOD(...) {
                $CONFIG.ServerName = ""
              }
          - pattern: |
              $DIRECT_CONNECT := $FUNC(...)
              if $DIRECT_CONNECT {
                $CONFIG.InsecureSkipVerify = true
              }
    fix: Use service mesh routing and let the mesh handle service-to-service communication
    metadata:
      category: tls_runtime_security
      cwe: CWE-295
      impact: Service mesh bypass eliminates mTLS protection and security observability
