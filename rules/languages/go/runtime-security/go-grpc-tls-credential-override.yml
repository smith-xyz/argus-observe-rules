rules:
  - id: go-grpc-tls-credential-override
    message: gRPC TLS credential override detected - may bypass service mesh security
    severity: ERROR
    languages:
      - go
    patterns:
      - pattern-either:
          # gRPC-specific insecure credential patterns
          - pattern: grpc.WithInsecure()
          - pattern: grpc.WithTransportCredentials(insecure.NewCredentials())
          - pattern: |
              if $CONDITION {
                $OPTS = append($OPTS, grpc.WithInsecure())
              }
          - pattern: |
              var $CREDS credentials.TransportCredentials
              if $CONDITION {
                $CREDS = insecure.NewCredentials()
              }
          - pattern: |
              grpc.WithUnaryInterceptor(func($CTX context.Context, $METHOD string, $REQ, $REPLY interface{}, $CC *grpc.ClientConn, $INVOKER grpc.UnaryInvoker, $OPTS ...grpc.CallOption) error {
                ...
                if $BYPASS_TLS {
                  $OPTS = append($OPTS, grpc.WithInsecure())
                }
                ...
              })
          - pattern: grpc.NewServer(grpc.Creds(insecure.NewCredentials()))
          - pattern: |
              $INSECURE := $FUNC(...)
              if $INSECURE {
                $OPTS = append($OPTS, grpc.WithInsecure())
              }
    fix: Use service mesh mTLS or properly configured TLS credentials
    metadata:
      category: tls_runtime_security
      cwe: CWE-295
      impact: gRPC credential override bypasses service mesh security and mTLS policies
